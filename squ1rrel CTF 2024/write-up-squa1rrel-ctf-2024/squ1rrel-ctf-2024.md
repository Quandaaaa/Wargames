---
weight: 1
title: "SQU1RREL CTF 2024"
date: 2023-07-20T15:02:00+06:00
lastmod: 2023-07-22T15:20:00+06:00
draft: false
author: "Quanda"
authorLink: "https://quanda.github.io"
description: "Writeup for the Ice cream generator Cryptography challenge."

tags: ["crypto"]
categories: ["Writeups"]

lightgallery: true

toc:
  enable: true
---
# SQU1RREL CTF 2024
Write-up for SQU1RREL CTF 2024
<!--more-->
## Lazy RSA
{{< admonition note "Challenge Information" >}}
![alt text](image/image.png)
{{< /admonition >}}
```lazyrsa.txt=
n: 23690620655271165329693230765997410033604713853187305472268813793031152348107488119317901392104240429826482611449247251262846508667797483465355228800439339041030982259847598574606272955688345490638311164838117491821117626835340577511562130640807587611523935604871183668968359720411023759980144229161581597397061850707647104033348795132205561234674677139395868595692235525931999596382758921793937149945229459379437008216713404350896206374483356969246476531491049930769999387038678280465689487577291475554699094024761030833540509263174840007922218340417888061099317752496279552046029470370474619439450870110783844218281
e: 65537
ct: 11420169733597912638453974310976296342840438772934899653944946284527921765463891354182152294616337665313108085636067061251485792996493148094827999964385583364992542843630846911864602981658349693548380259629884212903554470004231160866680745154066318419977485221228944716844036265911222656710479650139274719426252576406561307088938784324291655853920727176132853663822020880574204790442647169649094846806057218165102873847070323190392619997632103724159815363319643022552432448214770378596825200154298562513279104608157870845848578603703757405758227316242247843290673221718467366000253484278487854736033323783510299081405
```
N factor ƒë∆∞·ª£c n√™n ta d·ªÖ d√†ng c√≥ ƒë∆∞·ª£c FLAG.

> Flag: squ1rrel{laziness_will_be_the_answer_eventually}

## RSA RSA RSA
{{< admonition note "Challenge Information" >}}
![alt text](image/image-1.png)
{{< /admonition >}}

```
e: 3
n1: 96137714481560340073780038250015316564930752333880363375193088083653975552334517899735106334409092229494004991796910602440032630762575914714152238916128674595912438177270978040111855327624812652948702562503276973409716595778936978757384935820012322432156169815110042972411989274515686945691887468406312791931
ct1: 45640508926729498938915879450220374487095109122207451961200230820161694723491945276893630019713859109920025191680053056485030809079137883906737197875968862878423820820515399840094772412319820062860149582361429346029277273870654355752499436360499181221418835401103925420623212341317366954144592892392013649421
n2: 90990790933807553440094447797505116528289571569256574363585309090304380702927241663491819956599368816997683603352289726407304960362149545383683196526764288524742203975596414405902155486632888712453606841629050125783639571606440840246928825545860143096340538904060826483178577619093666337611264852255012241011
ct2: 58149644956871439128498229750735120049939213159976216414725780828349070974351356297226894029560865402164610877553706310307735037479690463594397903663323983980128060190648604447657636452565715178438939334318494616246072096228912870579093620604596752844583453865894005036516299903524382604570097012992290786402
n3: 86223965871064436340735834556059627182534224217231808576284808010466364412704836149817574186647031512768701943310184993378236691990480428328117673064942878770269493388776005967773324771885109757090215809598845563135795831857972778498394289917587876390109949975194987996902591291672194435711308385660176310561
ct3: 16168828246411344105159374934034075195568461748685081608380235707338908077276221477034184557590734407998991183114724523494790646697027318500705309235429037934125253625837179003478944984233647083364969403257234704649027075136139224424896295334075272153594459752240304700899700185954651799042218888117178057955
```
V·ªõi b√†i n√†y ta nghƒ© ƒë·∫øn ngay `CRT`. <br>
**Solution:**
```python
from Crypto.Util.number import long_to_bytes
e = 3
n1 = 96137714481560340073780038250015316564930752333880363375193088083653975552334517899735106334409092229494004991796910602440032630762575914714152238916128674595912438177270978040111855327624812652948702562503276973409716595778936978757384935820012322432156169815110042972411989274515686945691887468406312791931
ct1 = 45640508926729498938915879450220374487095109122207451961200230820161694723491945276893630019713859109920025191680053056485030809079137883906737197875968862878423820820515399840094772412319820062860149582361429346029277273870654355752499436360499181221418835401103925420623212341317366954144592892392013649421
n2 = 90990790933807553440094447797505116528289571569256574363585309090304380702927241663491819956599368816997683603352289726407304960362149545383683196526764288524742203975596414405902155486632888712453606841629050125783639571606440840246928825545860143096340538904060826483178577619093666337611264852255012241011
ct2 = 58149644956871439128498229750735120049939213159976216414725780828349070974351356297226894029560865402164610877553706310307735037479690463594397903663323983980128060190648604447657636452565715178438939334318494616246072096228912870579093620604596752844583453865894005036516299903524382604570097012992290786402
n3 = 86223965871064436340735834556059627182534224217231808576284808010466364412704836149817574186647031512768701943310184993378236691990480428328117673064942878770269493388776005967773324771885109757090215809598845563135795831857972778498394289917587876390109949975194987996902591291672194435711308385660176310561
ct3 = 16168828246411344105159374934034075195568461748685081608380235707338908077276221477034184557590734407998991183114724523494790646697027318500705309235429037934125253625837179003478944984233647083364969403257234704649027075136139224424896295334075272153594459752240304700899700185954651799042218888117178057955
N = [n1, n2, n3]
C = [ct1, ct2, ct3]
m = pow(crt(C, N), 1/3)
long_to_bytes(int(m))
```

> flag: squ1rrel{math_is_too_powerful_1q3y41t1s98u23rf8}

# Partial RSA
{{< admonition note "Challenge Information" >}}
![alt text](image/image-2.png)
{{< /admonition >}}
```
n: 103805634552377307340975059685101156977551733461056876355507089800229924640064014138267791875318149345634740763575673979991819014964446415505372251293888861031929442007781059010889724977253624216086442025183181157463661838779892334251775663309103173737456991687046799675461756638965663330282714035731741912263
e: 3
ct: 24734873977910637709237800614545622279880260333085506891667302143041484966318230317192234785987158021463825782079898979505470029030138730760671563038827274105816021371073990041986605112686349050253522070137824687322227491501626342218176173909258627357031402590581822729585520702978374712113860530427142416062
```

* :bulb:Khi ƒë·ªçc hint c·ªßa ƒë·ªÅ, m√¨nh bi·∫øt l√† ph·∫£i s·ª≠ d·ª•ng `form flag` ƒë·ªÉ gi·∫£i b√†i n√†y.

* Flag s·∫Ω c√≥ d·∫°ng: `squ1rrel{?}`. Nh∆∞ v·∫≠y ta ƒë√£ bi·∫øt ƒë∆∞·ª£c 9 bytes ƒë·∫ßu c·ªßa Flag v√† ta c·∫ßn t√¨m c√°c bytes c√≤n l·∫°i.
* G·ªçi $x$ l√† ƒëo·∫°n ph·∫ßn flag c·∫ßn t√¨m, $a$ l√† form flag. 
* Ta c√≥:
$$m = bytes\_{to}\_{long(a)}*256^{len(x)} + bytes\_{to}\_{long(x)}$$
* Ta c√≥ ph∆∞∆°ng tr√¨nh nh∆∞ sau:
$$m^3 - ct= 0 \pmod n$$
Ta s·∫Ω gi·∫£i ph∆∞∆°ng tr√¨nh n√†y b·∫±ng `small_root`. Nh∆∞ng v√¨ kh√¥ng bi·∫øt ƒë·ªô d√†i c·ªßa flag n√™n ta s·∫Ω `brute-force` ƒë·ªô d√†i c·ªßa n√≥.<br>
**Sage:**
```Python
from Crypto.Util.number import bytes_to_long, long_to_bytes
n = 103805634552377307340975059685101156977551733461056876355507089800229924640064014138267791875318149345634740763575673979991819014964446415505372251293888861031929442007781059010889724977253624216086442025183181157463661838779892334251775663309103173737456991687046799675461756638965663330282714035731741912263
e = 3
c = 24734873977910637709237800614545622279880260333085506891667302143041484966318230317192234785987158021463825782079898979505470029030138730760671563038827274105816021371073990041986605112686349050253522070137824687322227491501626342218176173909258627357031402590581822729585520702978374712113860530427142416062

a = bytes_to_long(b'squ1rrel{')
P.<x> = PolynomialRing(Zmod(n))
for i in range(30, 50):
    f = ((a*256**i + x)**3 - c)
    tmp = f.small_roots(X = 256**i , beta = i/(len('squ1rrel{') + i))
    if len(tmp) !=0 :
        print(b'squ1rrel{' + long_to_bytes(int(tmp[0])))
        break
```
>flag: squ1rrel{wow_i_was_betrayed_by_my_own_friend}

## squ1rrel treasury
{{< admonition note "Challenge Information" >}}
![alt text](image/image-3.png)
{{< /admonition >}}
- `nc treasury.squ1rrel-ctf-codelab.kctf.cloud 1337`

[chall.py](https://squ1rrel-ctf-uploads.storage.googleapis.com/uploads/1f32e9b81e3d43fc0bca8f9b9104ec2cc0173ec1eb441924e2a7b1ab9435bfed/chall.py)

ƒê·ªçc k·ªπ source code ta nh·∫≠n ra c√°ch m√£ h√≥a `Key` c·ªßa n√≥ ch√≠nh l√† CBC, th·∫ø m√† √¥ng author c·ª© th√≠ch vi·∫øt d√†i d√≤ng th√¥iii ü§°. V√† ta s·∫Ω s·ª≠ d·ª•ng Flip CBC ƒë·ªÉ l·∫•y ƒë∆∞·ª£c FLAG.
```python
def getKey(self):
        save = f"{self.__name}:{self.__balance}".encode()
        blocks = blockify(save, AES.block_size)
        pblocks = pad(blocks, b'\x00', AES.block_size)
        cipher = AES.new(KEY, AES.MODE_ECB)
        ct = []
        for i, b in enumerate(pblocks):
            if i == 0:
                tmp = strxor(b, self.__iv)
                ct.append(cipher.encrypt(tmp))
            else:
                tmp = strxor(strxor(ct[i-1], pblocks[i-1]), b)
                ct.append(cipher.encrypt(tmp))
        ct_str = f"{self.__iv.hex()}:{(b''.join(ct)).hex()}"
        return ct_str

    def load(key: str):
        key_split = key.split(':')
        iv = bytes.fromhex(key_split[0])
        ct = bytes.fromhex(key_split[1])
        cipher = AES.new(KEY, AES.MODE_ECB)
        pt = blockify(cipher.decrypt(ct), AES.block_size)
        ct = blockify(ct, AES.block_size)
        for i, p in enumerate(pt):
            if i == 0:
                pt[i] = strxor(p, iv)
            else:
                pt[i] = strxor(strxor(ct[i-1], pt[i-1]), p)
        pt = b''.join(pt)
        pt_split = pt.split(b':')
        try:
            name = pt_split[0].decode()
        except Exception:
            name = "ERROR"
        balance = int(pt_split[1].strip(b'\x00').decode())
        return Account(iv, name, balance)
```
* Ban ƒë·∫ßu `balance = 0` v√† n√≥ s·∫Ω ƒë∆∞·ª£c g·ªôp v·ªõi `name` ƒë·ªÉ m√£ h√≥a v√† tr·∫£ v·ªÅ cho ta `ciphertext`, `iv`.
* V√≠ d·ª• t√™n ta g·ª≠i v√†o l√†: `name = "quanda"`, th√¨ s·∫Ω tr·∫£ v·ªÅ `encrypt_CBC("quanda:0")`.
* Ta c√≥ `max(FLAG_COST) = 10**14-1` n√™n target c·ªßa ta l√† `balance = max(FLAG_COST)`.

**FLip CBC**
* C√°ch ho·∫°t ƒë·ªông c·ªßa CBC:
![alt text](image/image-5.png)
* M√†u xanh c·ªßa iv cho th·∫•y Plaintext thay ƒë·ªïi v·ªõi bytes t∆∞∆°ng ·ª©ng v·ªõi iv. C√≤n m√†u ƒë·ªè c·ªßa ciphertext c·ªßa block th·ª© 2 n√≥ c√≥ ·∫£nh h∆∞·ªüng l√†m thay ƒë·ªïi to√†n b·ªô plaintext.
* Ta c√≥: <br>
$P_1 = Dec_k(C1) \bigoplus IV$ <br>
* Set: $target = Dec_k(C1) \bigoplus IV'$
$\to IV' = IV \bigoplus P_1 \bigoplus target$

* M√¨nh s·∫Ω ch·ªçn `name = "a"*14` khi ƒë√≥ ta s·∫Ω c√≥ m·ªôt block l√†: `p = "aaaaaaaaaaaaaa:0"`
* Target m√¨nh ch·ªçn l√† `t = "a:99999999999999"`.
* V√¨ kh√¥ng s·ª≠ d·ª•ng qu√° nhi·ªÅu payload n√™n m√¨nh s·∫Ω nh·∫≠p tr·ª±c ti·∫øp ƒë·∫øn server lu√¥n n√™n s·∫Ω kh√¥ng c√≥ script n√†o c·∫£ ü§£.
* ƒê√¢y l√† ƒëo·∫°n t√≠nh to√°n `new_iv`.
```python
iv = bytes.fromhex('4a048459ad3ebc3b68c4c61d091a4b9b')
target = b'a:'+b'9'*14
c = bytes.fromhex("4ccffa2f796ce4381f37ba63a74d8a99")
new_iv = xor(xor(target, b'a'*14+b':0'), iv).hex()
print(new_iv)
```

>Flag: squ1rrel{7H3_4C0rN_3NCrYP710N_5CH3M3_15_14CK1N6}

## Squ1rrel Lottery
{{< admonition note "Challenge Information" >}}
![alt text](image-4.png)
[squ1rrel-lottery.py](https://squ1rrel-ctf-uploads.storage.googleapis.com/uploads/e3d653cdb94418525b8d5848b1267d902fb1bbc76191aa26c7826f1ae8495cb0/squ1rrel-lottery.py)
* `nc 34.132.166.199 11112` 
{{< /admonition >}}

```python
import random

# user version
def input_lines():
    lines = []
    print("Welcome to the squ1rrel lottery! 9 winning numbers will be selected, and if any of your tickets share 3 numbers with the winning ticket you'll win! Win 1000 times in a row to win a flag")
    for i in range(1, 41):
        while True:
            line = input(f"Ticket {i}: ").strip()
            numbers = line.split()
            if len(numbers) != 9:
                print("Please enter 9 numbers")
                continue
            try:
                numbers = [int(num) for num in numbers]
                if not all(1 <= num <= 60 for num in numbers):
                    print("Numbers must be between 1 and 60")
                    continue
                lines.append(set(numbers))
                break
            except ValueError:
                print("Please enter only integers.")
    return lines


user_tickets = input_lines()
wincount = 0
for j in range(1000):
    winning_ticket = random.sample(range(1, 61), 9)

    win = False
    for i in user_tickets:
        if len(i.intersection(set(winning_ticket))) >= 3:
            print(f'Win {j}!')
            win = True
            wincount += 1
            break
    if not win:
        print("99 percent of gamblers quit just before they hit it big")
        break

if wincount == 1000:
    print("squ1rrelctf{test_flag}")
```

V·ªõi challenge n√†y ta s·∫Ω gen ra 40 ticket. N·∫øu nh∆∞ c√≥ m·ªôt trong 40 ticket ƒë√≥ c√≥ 3 s·ªë trong winning_ticket th√¨ s·∫Ω th·∫Øng. V√† ta ph·∫£i d√πng 40 ticket ƒë√≥ ƒë·ªÉ th·∫Øng 1000 th√¨ ta s·∫Ω FLAG.

M·ªói ticket bao g·ªìm 9 s·ªë kh√°c nhau t·ª´ 1 ƒë·∫øn 60. 
